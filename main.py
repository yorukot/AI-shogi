import re
import os
import cv2
import requests
from ultralytics import YOLO


# WARN: remove print and saving images in comp
def check():
    # Initialization
    test_path = "./test/images"
    output_path = "./output/"
    os.makedirs(output_path, exist_ok=True)

    model = YOLO('./runs/detect/train10/weights/best.pt')
    image_files = sorted([f for f in os.listdir(test_path) if f.endswith(('.jpg', '.png', '.jpeg'))])

    for img_name in image_files:
        img_path = os.path.join(test_path, img_name)
        img = cv2.imread(img_path)
        img_width = img.shape[1]  # Get image width
        left_threshold = img_width * 0.25  # Left 25% boundary
        right_threshold = img_width * 0.75  # Right 25% boundary
        
        results = model(img)
        region_counts = {'A': 0, 'B': 0, 'C': 0, 'D': 0}
        for result in results:
            boxes = result.boxes.xyxy.cpu().numpy()
            labels = result.boxes.cls.cpu().numpy()
            for box, label in zip(boxes, labels):
                x1, y1, x2, y2 = map(int, box)
                center_x = (x1 + x2) / 2  # Calculate center x-coordinate of the bounding box
                label = int(label)
                
                # Check position for special C and D classifications
                if center_x > right_threshold:  # Right 25% of the image
                    region_counts['C'] += 1
                    color = (0, 0, 255)  # Red color for type C
                elif center_x < left_threshold:  # Left 25% of the image
                    region_counts['D'] += 1
                    color = (0, 255, 0)  # Green color for type D
                elif label == 0:
                    region_counts['A'] += 1
                    color = (255, 0, 0)  # Blue color for type A
                elif label == 1:
                    region_counts['B'] += 1
                    color = (255, 255, 0)  # Cyan color for type B
                elif label == 2:
                    region_counts['C'] += 1
                    color = (0, 0, 255)  # Red color for type C
                elif label == 3:
                    region_counts['D'] += 1
                    color = (0, 255, 0)  # Green color for type D
                else:
                    continue

                cv2.rectangle(img, (x1, y1), (x2, y2), color, 2)
                
                # Add position label for pieces in the left or right 25%
                if center_x > right_threshold:
                    cv2.putText(img, 'C (Right)', (x1, y1-10), cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)
                elif center_x < left_threshold:
                    cv2.putText(img, 'D (Left)', (x1, y1-10), cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)

        # Draw the 25% threshold lines on the image
        cv2.line(img, (int(left_threshold), 0), (int(left_threshold), img.shape[0]), (255, 255, 255), 1)
        cv2.line(img, (int(right_threshold), 0), (int(right_threshold), img.shape[0]), (255, 255, 255), 1)

        for i, (region, count) in enumerate(region_counts.items()):
            cv2.putText(img, f'{region}: {count}', (10, 30 + i * 30), cv2.FONT_HERSHEY_SIMPLEX, 0.8, (255, 255, 255), 2)

        output_img_path = os.path.join(output_path, img_name)
        cv2.imwrite(output_img_path, img)

    print("標示完成，結果已儲存至:", output_path)
    return region_counts


answers = check()
# school_name = "台灣中港高中"
#
#
# def postAnswer(school_name, answers):
#     """
#     school_name: str
#         投稿する学校名。matches[0] に対応する。
#     answers: list[list]
#         2次元配列。
#         例: [[1,2,3,4],[5,6,7,8], ...]
#         これらをフラットにして matches[1] 以降に順番に割り当てる。
#     """
#     print(str(answers))
#     # GoogleFormのURL
#     FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSe6Oc5gxcYuzZsB03Nzj-QloGZXYMqN00a6KyJEMRGG4-hB2A/formResponse"
#
#     # GoogleFormのHTML構造を解析してエントリー名を得る
#     html = """
#     <div jsname="o6bZLc"><input type="hidden" name="entry.1449005772" value="aaa"><input type="hidden" name="entry.724101180" value=""><input type="hidden" name="entry.2011224978" value=""><input type="hidden" name="entry.1079357435" value=""><input type="hidden" name="entry.739605324" value=""><input type="hidden" name="entry.2088172053" value=""><input type="hidden" name="entry.1423871455" value=""><input type="hidden" name="entry.1002984388" value=""><input type="hidden" name="entry.664451995" value=""><input type="hidden" name="entry.1842912509" value=""><input type="hidden" name="entry.1053929768" value=""><input type="hidden" name="entry.829852703" value=""><input type="hidden" name="entry.349743782" value=""><input type="hidden" name="entry.1871004447" value=""><input type="hidden" name="entry.1924778191" value=""><input type="hidden" name="entry.1692974201" value=""><input type="hidden" name="entry.2071020206" value=""><input type="hidden" name="entry.650166651" value=""><input type="hidden" name="entry.2099192050" value=""><input type="hidden" name="entry.121053473" value=""><input type="hidden" name="entry.1755917932" value=""><input type="hidden" name="entry.672982948" value=""><input type="hidden" name="entry.1963918051" value=""><input type="hidden" name="entry.1871423104" value=""><input type="hidden" name="entry.80506154" value=""><input type="hidden" name="entry.1498736199" value=""><input type="hidden" name="entry.302553438" value=""><input type="hidden" name="entry.1809972235" value=""><input type="hidden" name="entry.420052784" value=""><input type="hidden" name="entry.433969180" value=""><input type="hidden" name="entry.1647494352" value=""><input type="hidden" name="entry.1780791692" value=""><input type="hidden" name="entry.1775231689" value=""><input type="hidden" name="entry.567371048" value=""><input type="hidden" name="entry.1446381559" value=""><input type="hidden" name="entry.574130816" value=""><input type="hidden" name="entry.514433542" value=""><input type="hidden" name="entry.1074383765" value=""><input type="hidden" name="entry.764847599" value=""><input type="hidden" name="entry.1130232597" value=""><input type="hidden" name="entry.298944052" value=""><input type="hidden" name="entry.1524877061" value=""><input type="hidden" name="entry.669721295" value=""><input type="hidden" name="entry.772620952" value=""><input type="hidden" name="entry.1827169913" value=""><input type="hidden" name="entry.1937400789" value=""><input type="hidden" name="entry.659481769" value=""><input type="hidden" name="entry.1973831652" value=""><input type="hidden" name="entry.672739998" value=""><input type="hidden" name="entry.460295265" value=""><input type="hidden" name="entry.208508426" value=""><input type="hidden" name="entry.1082453715" value=""><input type="hidden" name="entry.1484285755" value=""><input type="hidden" name="entry.843575656" value=""><input type="hidden" name="entry.311537272" value=""><input type="hidden" name="entry.1533171087" value=""><input type="hidden" name="entry.387997232" value=""><input type="hidden" name="entry.1568205406" value=""><input type="hidden" name="entry.1291939121" value=""><input type="hidden" name="entry.929849508" value=""><input type="hidden" name="entry.869023135" value=""><input type="hidden" name="entry.1921394939" value=""><input type="hidden" name="entry.2114696860" value=""><input type="hidden" name="entry.1932550404" value=""><input type="hidden" name="entry.1121936026" value=""><input type="hidden" name="entry.1415509354" value=""><input type="hidden" name="entry.1817675586" value=""><input type="hidden" name="entry.628205036" value=""><input type="hidden" name="entry.1908288966" value=""><input type="hidden" name="entry.2091866336" value=""><input type="hidden" name="entry.595428229" value=""><input type="hidden" name="entry.1106400591" value=""><input type="hidden" name="entry.14217992" value=""><input type="hidden" name="entry.1702918830" value=""><input type="hidden" name="entry.1230080338" value=""><input type="hidden" name="entry.6086895" value=""><input type="hidden" name="entry.2065978763" value=""><input type="hidden" name="entry.707309126" value=""><input type="hidden" name="entry.2079592653" value=""><input type="hidden" name="entry.1605948282" value=""><input type="hidden" name="entry.1408836626" value=""><input type="hidden" name="entry.1001486005" value=""><input type="hidden" name="entry.333628222" value=""><input type="hidden" name="entry.2029963449" value=""><input type="hidden" name="entry.34044012" value=""><input type="hidden" name="entry.272201631" value=""><input type="hidden" name="entry.1411704151" value=""><input type="hidden" name="entry.639969782" value=""><input type="hidden" name="entry.1391605770" value=""><input type="hidden" name="entry.804115117" value=""><input type="hidden" name="entry.348722896" value=""><input type="hidden" name="entry.483418781" value=""><input type="hidden" name="entry.1308042363" value=""><input type="hidden" name="entry.1260349582" value=""><input type="hidden" name="entry.106295579" value=""><input type="hidden" name="entry.290073471" value=""><input type="hidden" name="entry.460529602" value=""><input type="hidden" name="entry.792629876" value=""><input type="hidden" name="entry.4410527" value=""><input type="hidden" name="entry.805473516" value=""><input type="hidden" name="entry.1936405312" value=""><input type="hidden" name="entry.1337888382" value=""><input type="hidden" name="entry.1206720125" value=""><input type="hidden" name="entry.60781349" value=""><input type="hidden" name="entry.1151313729" value=""><input type="hidden" name="entry.1165341127" value=""><input type="hidden" name="entry.1280375989" value=""><input type="hidden" name="entry.2016956868" value=""><input type="hidden" name="entry.752163444" value=""><input type="hidden" name="entry.964176044" value=""><input type="hidden" name="entry.143872780" value=""><input type="hidden" name="entry.849482903" value=""><input type="hidden" name="entry.478320311" value=""><input type="hidden" name="entry.1671854137" value=""><input type="hidden" name="entry.1060449438" value=""><input type="hidden" name="entry.1191882697" value=""><input type="hidden" name="entry.697547455" value=""><input type="hidden" name="entry.831492498" value=""><input type="hidden" name="entry.895859895" value=""><input type="hidden" name="entry.1213943751" value=""><input type="hidden" name="entry.1951123924" value=""><input type="hidden" name="entry.1866261254" value=""><input type="hidden" name="entry.303893606" value=""><input type="hidden" name="entry.1719782752" value=""><input type="hidden" name="entry.68746496" value=""><input type="hidden" name="entry.934601564" value=""><input type="hidden" name="entry.1141303876" value=""><input type="hidden" name="entry.1816825473" value=""><input type="hidden" name="entry.510864595" value=""><input type="hidden" name="entry.1030971319" value=""><input type="hidden" name="entry.1606063422" value=""><input type="hidden" name="entry.366036209" value=""><input type="hidden" name="entry.596338997" value=""><input type="hidden" name="entry.1569069481" value=""><input type="hidden" name="entry.286608920" value=""><input type="hidden" name="entry.1520086128" value=""><input type="hidden" name="entry.1704117216" value=""><input type="hidden" name="entry.1110138838" value=""><input type="hidden" name="entry.1690727309" value=""><input type="hidden" name="entry.158317409" value=""><input type="hidden" name="entry.2092983799" value=""><input type="hidden" name="entry.1602331770" value=""><input type="hidden" name="entry.1879368097" value=""><input type="hidden" name="entry.1201052602" value=""><input type="hidden" name="entry.359143581" value=""><input type="hidden" name="entry.380616379" value=""><input type="hidden" name="entry.1067059217" value=""><input type="hidden" name="entry.572679637" value=""><input type="hidden" name="entry.1807712247" value=""><input type="hidden" name="entry.1707246849" value=""><input type="hidden" name="entry.1552722391" value=""><input type="hidden" name="entry.1248469835" value=""><input type="hidden" name="entry.1627843043" value=""><input type="hidden" name="entry.1643485386" value=""><input type="hidden" name="entry.1028940972" value=""><input type="hidden" name="entry.1947667577" value=""><input type="hidden" name="entry.2099487672" value=""><input type="hidden" name="entry.79625495" value=""><input type="hidden" name="entry.1994923367" value=""><input type="hidden" name="entry.1803239829" value=""><input type="hidden" name="entry.1010881022" value=""><input type="hidden" name="entry.358037998" value=""><input type="hidden" name="entry.2120726496" value=""><input type="hidden" name="entry.1562947015" value=""><input type="hidden" name="entry.1870126903" value=""><input type="hidden" name="entry.1439324613" value=""><input type="hidden" name="entry.68574818" value=""><input type="hidden" name="entry.2143867496" value=""><input type="hidden" name="entry.1981328035" value=""><input type="hidden" name="entry.546129984" value=""><input type="hidden" name="entry.1026965263" value=""><input type="hidden" name="entry.1204120782" value=""><input type="hidden" name="entry.1019218116" value=""><input type="hidden" name="entry.490370965" value=""><input type="hidden" name="entry.2109353153" value=""><input type="hidden" name="entry.280539700" value=""><input type="hidden" name="entry.1238938901" value=""><input type="hidden" name="entry.1171291251" value=""><input type="hidden" name="entry.908192328" value=""><input type="hidden" name="entry.1411745397" value=""><input type="hidden" name="entry.1383158332" value=""><input type="hidden" name="entry.876243392" value=""><input type="hidden" name="entry.402184411" value=""><input type="hidden" name="entry.1410824737" value=""><input type="hidden" name="entry.308481381" value=""><input type="hidden" name="entry.980888593" value=""><input type="hidden" name="entry.246499691" value=""><input type="hidden" name="entry.1304966855" value=""><input type="hidden" name="entry.1794577294" value=""><input type="hidden" name="entry.716713719" value=""><input type="hidden" name="entry.287395389" value=""><input type="hidden" name="entry.211833535" value=""><input type="hidden" name="entry.1388888400" value=""><input type="hidden" name="entry.736562387" value=""><input type="hidden" name="entry.1961179097" value=""><input type="hidden" name="entry.1458452438" value=""><input type="hidden" name="entry.1060174653" value=""><input type="hidden" name="entry.1799133765" value=""><input type="hidden" name="entry.1293715164" value=""><input type="hidden" name="entry.35226073" value=""><input type="hidden" name="entry.683030431" value=""><input type="hidden" name="entry.1247574759" value=""><input type="hidden" name="entry.67138887" value=""><input type="hidden" name="entry.461669650" value=""><input type="hidden" name="entry.2130048742" value=""><input type="hidden" name="entry.1580014586" value=""><input type="hidden" name="entry.2105475860" value=""><input type="hidden" name="entry.1530516110" value=""><input type="hidden" name="entry.491797807" value=""><input type="hidden" name="entry.258285229" value=""><input type="hidden" name="entry.1864258428" value=""><input type="hidden" name="entry.1959418026" value=""><input type="hidden" name="entry.1189117192" value=""><input type="hidden" name="entry.379282796" value=""><input type="hidden" name="entry.1309935521" value=""><input type="hidden" name="entry.1841493829" value=""><input type="hidden" name="entry.1266501980" value=""><input type="hidden" name="entry.2072332795" value=""><input type="hidden" name="entry.903000178" value=""><input type="hidden" name="entry.1841952710" value=""><input type="hidden" name="entry.99239525" value=""><input type="hidden" name="entry.754181442" value=""><input type="hidden" name="entry.1254749163" value=""><input type="hidden" name="entry.976947868" value=""><input type="hidden" name="entry.1105402908" value=""><input type="hidden" name="entry.203648407" value=""><input type="hidden" name="entry.794824131" value=""><input type="hidden" name="entry.1032729101" value=""><input type="hidden" name="entry.1169201417" value=""><input type="hidden" name="entry.2018937154" value=""><input type="hidden" name="entry.1304246207" value=""><input type="hidden" name="entry.2116428482" value=""><input type="hidden" name="entry.513878056" value=""><input type="hidden" name="entry.94457056" value=""><input type="hidden" name="entry.1228213429" value=""><input type="hidden" name="entry.952428640" value=""><input type="hidden" name="entry.138028992" value=""><input type="hidden" name="entry.1391474944" value=""><input type="hidden" name="entry.1782842141" value=""><input type="hidden" name="entry.713665491" value=""><input type="hidden" name="entry.1140693087" value=""><input type="hidden" name="entry.1015386429" value=""><input type="hidden" name="entry.293116477" value=""><input type="hidden" name="entry.41916756" value=""><input type="hidden" name="entry.225062383" value=""><input type="hidden" name="entry.1835490335" value=""><input type="hidden" name="entry.1612027179" value=""><input type="hidden" name="entry.1797058682" value=""><input type="hidden" name="entry.1456596285" value=""><input type="hidden" name="entry.690672736" value=""><input type="hidden" name="entry.1948005839" value=""><input type="hidden" name="entry.1549823447" value=""><input type="hidden" name="entry.587501720" value=""><input type="hidden" name="entry.1944077296" value=""><input type="hidden" name="entry.160236046" value=""><input type="hidden" name="entry.1817402789" value=""><input type="hidden" name="entry.370420916" value=""><input type="hidden" name="entry.2015142779" value=""><input type="hidden" name="entry.1218468367" value=""><input type="hidden" name="entry.1122379877" value=""><input type="hidden" name="entry.2055123463" value=""><input type="hidden" name="entry.1502555862" value=""><input type="hidden" name="entry.1023289316" value=""><input type="hidden" name="entry.1980997857" value=""><input type="hidden" name="entry.880799059" value=""><input type="hidden" name="entry.1052669107" value=""><input type="hidden" name="entry.57961553" value=""><input type="hidden" name="entry.77258540" value=""><input type="hidden" name="entry.21210735" value=""><input type="hidden" name="entry.2084544496" value=""><input type="hidden" name="entry.313553137" value=""><input type="hidden" name="entry.344594855" value=""><input type="hidden" name="entry.1026047231" value=""><input type="hidden" name="entry.1460699100" value=""><input type="hidden" name="entry.884337660" value=""><input type="hidden" name="entry.1586275698" value=""><input type="hidden" name="entry.775164966" value=""><input type="hidden" name="entry.19881645" value=""><input type="hidden" name="entry.1312970795" value=""><input type="hidden" name="entry.1159260408" value=""><input type="hidden" name="entry.219954397" value=""><input type="hidden" name="entry.725261913" value=""><input type="hidden" name="entry.1024813265" value=""><input type="hidden" name="entry.265074509" value=""><input type="hidden" name="entry.576306898" value=""><input type="hidden" name="entry.1281718174" value=""><input type="hidden" name="entry.1362499819" value=""><input type="hidden" name="entry.232991762" value=""><input type="hidden" name="entry.617120323" value=""><input type="hidden" name="entry.643774077" value=""><input type="hidden" name="entry.1213939468" value=""><input type="hidden" name="entry.1501743447" value=""><input type="hidden" name="entry.1503066016" value=""><input type="hidden" name="entry.316319711" value=""><input type="hidden" name="entry.2097404969" value=""><input type="hidden" name="entry.66170470" value=""><input type="hidden" name="entry.963776560" value=""><input type="hidden" name="entry.1559411647" value=""><input type="hidden" name="entry.969319155" value=""><input type="hidden" name="entry.944901000" value=""><input type="hidden" name="entry.489687574" value=""><input type="hidden" name="entry.361329312" value=""><input type="hidden" name="entry.977384312" value=""><input type="hidden" name="entry.2133769013" value=""><input type="hidden" name="entry.1506708774" value=""><input type="hidden" name="entry.614736907" value=""><input type="hidden" name="entry.1090351804" value=""><input type="hidden" name="entry.2059262122" value=""><input type="hidden" name="entry.1209633180" value=""><input type="hidden" name="entry.664268528" value=""><input type="hidden" name="entry.572479766" value=""><input type="hidden" name="entry.19944937" value=""><input type="hidden" name="entry.126130890" value=""><input type="hidden" name="entry.17871732" value=""><input type="hidden" name="entry.1637535339" value=""><input type="hidden" name="entry.1554549244" value=""><input type="hidden" name="entry.842627896" value=""><input type="hidden" name="entry.1790346109" value=""><input type="hidden" name="entry.589690808" value=""><input type="hidden" name="entry.1181755479" value=""><input type="hidden" name="entry.563841285" value=""><input type="hidden" name="entry.840873173" value=""><input type="hidden" name="entry.1508503762" value=""><input type="hidden" name="entry.183697090" value=""><input type="hidden" name="entry.1341102657" value=""><input type="hidden" name="entry.12463669" value=""><input type="hidden" name="entry.1740642232" value=""><input type="hidden" name="entry.401785446" value=""><input type="hidden" name="entry.1499266847" value=""><input type="hidden" name="entry.1776920967" value=""><input type="hidden" name="entry.174137845" value=""><input type="hidden" name="entry.398433561" value=""><input type="hidden" name="entry.1463141327" value=""><input type="hidden" name="entry.829259921" value=""><input type="hidden" name="entry.638092820" value=""><input type="hidden" name="entry.1652114495" value=""><input type="hidden" name="entry.550789099" value=""><input type="hidden" name="entry.830900454" value=""><input type="hidden" name="entry.1023826619" value=""><input type="hidden" name="entry.1806911066" value=""><input type="hidden" name="entry.498028103" value=""><input type="hidden" name="entry.1148186162" value=""><input type="hidden" name="entry.1590979795" value=""><input type="hidden" name="entry.1378969614" value=""><input type="hidden" name="entry.276610659" value=""><input type="hidden" name="entry.375874972" value=""><input type="hidden" name="entry.352938690" value=""><input type="hidden" name="entry.1862028158" value=""><input type="hidden" name="entry.1339463992" value=""><input type="hidden" name="entry.1519854465" value=""><input type="hidden" name="entry.1888121052" value=""><input type="hidden" name="entry.591412008" value=""><input type="hidden" name="entry.52699093" value=""><input type="hidden" name="entry.1144117285" value=""><input type="hidden" name="entry.855056571" value=""><input type="hidden" name="entry.354744527" value=""><input type="hidden" name="entry.613321414" value=""><input type="hidden" name="entry.649625527" value=""><input type="hidden" name="entry.1389905535" value=""><input type="hidden" name="entry.1698002877" value=""><input type="hidden" name="entry.1773946655" value=""><input type="hidden" name="entry.2040921712" value=""><input type="hidden" name="entry.274803518" value=""><input type="hidden" name="entry.1443579105" value=""><input type="hidden" name="entry.1384980187" value=""><input type="hidden" name="entry.824009276" value=""><input type="hidden" name="entry.586183628" value=""><input type="hidden" name="entry.177740840" value=""><input type="hidden" name="entry.313680717" value=""><input type="hidden" name="entry.925723602" value=""><input type="hidden" name="entry.843373363" value=""><input type="hidden" name="entry.1226575832" value=""><input type="hidden" name="entry.982439514" value=""><input type="hidden" name="entry.116761456" value=""><input type="hidden" name="entry.1204592892" value=""><input type="hidden" name="entry.1957338008" value=""><input type="hidden" name="entry.599935467" value=""><input type="hidden" name="entry.1041791967" value=""><input type="hidden" name="entry.2021347729" value=""><input type="hidden" name="entry.1787212994" value=""><input type="hidden" name="entry.237257347" value=""><input type="hidden" name="entry.759046187" value=""><input type="hidden" name="entry.405460008" value=""><input type="hidden" name="entry.1443183454" value=""><input type="hidden" name="entry.1648496566" value=""><input type="hidden" name="entry.2077834716" value=""><input type="hidden" name="entry.1173888807" value=""><input type="hidden" name="entry.19840384" value=""><input type="hidden" name="entry.889196832" value=""><input type="hidden" name="entry.1801810346" value=""><input type="hidden" name="entry.1926173311" value=""><input type="hidden" name="entry.1556391091" value=""><input type="hidden" name="entry.1839830932" value=""><input type="hidden" name="entry.1240193086" value=""><input type="hidden" name="entry.83079447" value=""><input type="hidden" name="entry.1922581767" value=""><input type="hidden" name="entry.1755125558" value=""><input type="hidden" name="entry.821005051" value=""><input type="hidden" name="entry.1818258314" value=""><input type="hidden" name="entry.1799872461" value=""><input type="hidden" name="entry.891957908" value=""><input type="hidden" name="dlut" value="1736942443095"></div>
#     """.strip()
#     pattern = r'name="(entry\.[^"]+)"'
#     matches = re.findall(pattern, html)
#     flattened_answers = []
#     for row in answers:
#         flattened_answers.extend(row)
#     payload = {matches[0]: school_name}
#     for i, ans in enumerate(flattened_answers):
#         if i + 1 < len(matches):
#             payload[matches[i + 1]] = ans
#         else:
#             break
#     response = requests.post(FORM_URL, data=payload)
#     if response.status_code == 200:
#         print("回答の送信に成功しました")
#     else:
#         print(f"回答の送信に失敗しました (status code: {response.status_code})")
#
#
# postAnswer(school_name, answers)
